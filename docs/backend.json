{
  "entities": {
    "User": {
      "$schema": "http://json-schema.org/draft-07/schema#",
      "title": "User",
      "type": "object",
      "description": "Represents a user of the Personal Investment Sage application.",
      "properties": {
        "id": {
          "type": "string",
          "description": "Unique identifier for the user entity."
        },
        "email": {
          "type": "string",
          "description": "Email address of the user.",
          "format": "email"
        },
        "riskProfile": {
          "type": "string",
          "description": "The risk profile of the user, determined by the AI.  Can be 'conservative', 'moderate', or 'aggressive'."
        }
      },
      "required": [
        "id",
        "email"
      ]
    },
    "Investment": {
      "$schema": "http://json-schema.org/draft-07/schema#",
      "title": "Investment",
      "type": "object",
      "description": "Represents a single investment asset.",
      "properties": {
        "id": {
          "type": "string",
          "description": "Unique identifier for the investment entity."
        },
        "userId": {
          "type": "string",
          "description": "Reference to User. (Relationship: User 1:N Investment)"
        },
        "name": {
          "type": "string",
          "description": "Name of the investment."
        },
        "type": {
          "type": "string",
          "description": "Type of investment (e.g., Stock, FII, Fixed Income, Cryptocurrency, ETF, Pension, Cash)."
        },
        "purchaseDate": {
          "type": "string",
          "description": "Date when the investment was purchased.",
          "format": "date-time"
        },
        "purchasePrice": {
          "type": "number",
          "description": "Price at which the investment was purchased."
        },
        "quantity": {
          "type": "number",
          "description": "Number of units purchased."
        },
        "brokerage": {
          "type": "string",
          "description": "Brokerage used for the investment."
        },
        "notes": {
          "type": "string",
          "description": "Optional notes about the investment."
        }
      },
      "required": [
        "id",
        "userId",
        "name",
        "type",
        "purchaseDate",
        "purchasePrice",
        "quantity",
        "brokerage"
      ]
    },
    "Alert": {
      "$schema": "http://json-schema.org/draft-07/schema#",
      "title": "Alert",
      "type": "object",
      "description": "Represents an alert generated by the AI assistant.",
      "properties": {
        "id": {
          "type": "string",
          "description": "Unique identifier for the alert entity."
        },
        "userId": {
          "type": "string",
          "description": "Reference to User. (Relationship: User 1:N Alert)"
        },
        "type": {
          "type": "string",
          "description": "Type of alert (e.g., High Volatility, Excessive Concentration, Maturity Reminder)."
        },
        "message": {
          "type": "string",
          "description": "The alert message."
        },
        "date": {
          "type": "string",
          "description": "Date and time the alert was generated.",
          "format": "date-time"
        },
        "investmentId": {
          "type": "string",
          "description": "Reference to Investment, if the alert is related to a specific investment. (Relationship: Investment 1:N Alert)"
        }
      },
      "required": [
        "id",
        "userId",
        "type",
        "message",
        "date"
      ]
    },
    "Snapshot": {
      "$schema": "http://json-schema.org/draft-07/schema#",
      "title": "Snapshot",
      "type": "object",
      "description": "Represents a snapshot of the user's portfolio at a specific point in time.",
      "properties": {
        "id": {
          "type": "string",
          "description": "Unique identifier for the snapshot entity."
        },
        "userId": {
          "type": "string",
          "description": "Reference to User. (Relationship: User 1:N Snapshot)"
        },
        "date": {
          "type": "string",
          "description": "Date and time the snapshot was taken.",
          "format": "date-time"
        },
        "portfolioAllocation": {
          "type": "string",
          "description": "JSON string representing the portfolio allocation by category at the time of the snapshot."
        },
        "investmentIds": {
          "type": "array",
          "description": "References to Investments included in the snapshot. (Relationship: Snapshot 1:N Investment)",
          "items": {
            "type": "string"
          }
        }
      },
      "required": [
        "id",
        "userId",
        "date",
        "portfolioAllocation"
      ]
    }
  },
  "auth": {
    "providers": [
      "password",
      "anonymous"
    ]
  },
  "firestore": {
    "structure": [
      {
        "path": "/users/{userId}",
        "definition": {
          "entityName": "User",
          "schema": {
            "$ref": "#/backend/entities/User"
          },
          "description": "Stores user profile information. Access is restricted to the user corresponding to the {userId}. All data within this collection is private and user-specific.",
          "params": [
            {
              "name": "userId",
              "description": "The unique identifier for the user."
            }
          ]
        }
      },
      {
        "path": "/users/{userId}/investments/{investmentId}",
        "definition": {
          "entityName": "Investment",
          "schema": {
            "$ref": "#/backend/entities/Investment"
          },
          "description": "Stores investment data for a specific user.  Access is restricted to the user corresponding to the {userId}.  All data within this collection is private and user-specific.",
          "params": [
            {
              "name": "userId",
              "description": "The unique identifier for the user."
            },
            {
              "name": "investmentId",
              "description": "The unique identifier for the investment."
            }
          ]
        }
      },
      {
        "path": "/users/{userId}/alerts/{alertId}",
        "definition": {
          "entityName": "Alert",
          "schema": {
            "$ref": "#/backend/entities/Alert"
          },
          "description": "Stores alerts generated for a specific user. Access is restricted to the user corresponding to the {userId}.  All data within this collection is private and user-specific.",
          "params": [
            {
              "name": "userId",
              "description": "The unique identifier for the user."
            },
            {
              "name": "alertId",
              "description": "The unique identifier for the alert."
            }
          ]
        }
      },
      {
        "path": "/users/{userId}/snapshots/{snapshotId}",
        "definition": {
          "entityName": "Snapshot",
          "schema": {
            "$ref": "#/backend/entities/Snapshot"
          },
          "description": "Stores snapshots of the user's portfolio at specific times. Access is restricted to the user corresponding to the {userId}.  All data within this collection is private and user-specific.",
          "params": [
            {
              "name": "userId",
              "description": "The unique identifier for the user."
            },
            {
              "name": "snapshotId",
              "description": "The unique identifier for the snapshot."
            }
          ]
        }
      }
    ],
    "reasoning": "The Firestore data structure is designed to ensure data isolation and security by leveraging path-based ownership for user-specific data. Each user has a dedicated subcollection for their investments, alerts, and snapshots, enabling secure and efficient data access. The design prioritizes Authorization Independence by avoiding `get()` calls in security rules. All security rules will be based on `request.auth.uid` and the path structure.\n\n*   **/users/{userId}**: Stores user profile data. This collection is primarily used for authentication and basic user information. Access is restricted to the user themselves, ensuring data privacy.\n*   **/users/{userId}/investments/{investmentId}**: This subcollection holds all investment data for a specific user. The `userId` in the path guarantees that only the authenticated user can access their investments. This structure directly supports the requirement that each user should only have access to their data. QAPs are satisfied via path-based ownership. The schema enforces invariants like `userId` matching the document path.\n*   **/users/{userId}/alerts/{alertId}**: Stores alerts generated for each user. Access is restricted based on the `userId` in the path, providing a clear and secure access model. QAPs are satisfied via path-based ownership. The schema enforces invariants like `userId` matching the document path.\n*   **/users/{userId}/snapshots/{snapshotId}**: Contains snapshots of the user's portfolio at specific times. Access control is managed through the `userId` in the path, ensuring that only the user can view their portfolio history. QAPs are satisfied via path-based ownership. The schema enforces invariants like `userId` matching the document path.\n\nThis structure avoids hierarchical authorization dependencies, allowing for atomic operations and improved debuggability. By segregating data based on user ID, the security rules are simplified and the risk of unauthorized access is minimized."
  }
}